{% extends "base.html" %}
{% block title %}Dashboard â€” {{ ui.app_title }}{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-8">
  <div>
    <h1 class="text-lg font-semibold text-[#e6edf3]">Repositories</h1>
    <p class="text-xs text-muted mt-0.5">Auto-deploy on <span class="text-accent">workflow_run â†’ completed â†’ success</span></p>
  </div>
  <div class="flex items-center gap-2">
    {% if gh_connected %}
    <span class="flex items-center gap-1.5 text-xs text-accent border rounded-lg px-3 py-1.5" style="border-color: {{ ui.accent_color }}44; background: {{ ui.accent_bg }}">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0 0 24 12c0-6.63-5.37-12-12-12z"/></svg>
      {% if gh_username %}@{{ gh_username }}{% else %}GitHub connected{% endif %}
    </span>
    {% elif gh_oauth_ok %}
    <a href="/auth/github?next=/repos/browse"
       class="btn-ghost inline-flex items-center gap-2 rounded-lg px-3 py-2 text-xs">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0 0 24 12c0-6.63-5.37-12-12-12z"/></svg>
      Connect GitHub
    </a>
    {% endif %}
    <a href="/repos/browse"
       class="btn-ghost inline-flex items-center gap-2 rounded-lg px-3 py-2 text-xs">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0 0 24 12c0-6.63-5.37-12-12-12z"/></svg>
      Browse GitHub
    </a>
    <a href="/repos/new"
       class="btn-primary inline-flex items-center gap-2 rounded-lg px-4 py-2 text-xs">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
      Add Repo
    </a>
  </div>
</div>

{% if not repos %}
<div class="card rounded-xl p-12 text-center">
  <div class="text-4xl mb-3">ðŸ“¦</div>
  <p class="text-[#e6edf3] text-sm font-medium mb-1">No repos configured yet</p>
  <p class="text-muted text-xs mb-5">Add a repo to start auto-deploying on push.</p>
  <a href="/repos/new" class="btn-primary inline-block rounded-lg px-5 py-2 text-xs">Add your first repo</a>
</div>
{% else %}

<div class="grid gap-3">
  {% for repo in repos %}
  <div class="card rounded-xl p-5 hover:border-[#8b949e] transition-colors glow">

    <!-- Info -->
    <div class="mb-4">
      <div class="flex items-center gap-2 flex-wrap mb-2">
        <span class="text-[#e6edf3] font-semibold text-sm">{{ repo.container_name }}</span>
        <span class="tag">{{ repo.github_repo }}</span>
        {% if repo.branch %}
        <span class="tag tag-info">{{ repo.branch }}</span>
        {% endif %}
        {% if repo.has_env %}
        <span class="tag" title=".env file stored" style="color:#3fb950;border-color:#3fb95044;background:#0a1a0d">ðŸ”’ env loaded</span>
        {% else %}
        <span class="tag tag-warn">no env</span>
        {% endif %}
      </div>

      <code class="text-xs text-[#58a6ff] block truncate mb-2">{{ repo.image }}</code>

      <div class="flex flex-wrap gap-4 text-xs text-muted">
        {% if repo.ports %}
        <span class="flex items-center gap-1">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg>
          {{ repo.ports }}
        </span>
        {% endif %}
        {% if repo.last_deployed %}
        <span class="flex items-center gap-1">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
          {{ repo.last_deployed[:19].replace("T"," ") }} UTC
        </span>
        {% else %}
        <span class="text-[#484f58]">never deployed</span>
        {% endif %}
      </div>
    </div>

    <!-- Actions -->
    <div class="flex flex-wrap items-center gap-2 pt-3 border-t border-[#30363d]">
      <a href="/repos/{{ repo.id }}/logs"
         class="btn-ghost inline-flex items-center gap-1.5 rounded-lg px-3 py-1.5 text-xs">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
        Logs
      </a>
      <a href="/repos/{{ repo.id }}/edit"
         class="btn-ghost inline-flex items-center gap-1.5 rounded-lg px-3 py-1.5 text-xs">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        Edit
      </a>
      <form method="post" action="/repos/{{ repo.id }}/deploy">
        <button type="submit"
                class="inline-flex items-center gap-1.5 rounded-lg px-3 py-1.5 text-xs font-medium text-[#58a6ff] border border-[#58a6ff44] bg-[#0d1117] hover:bg-[#1a2233] transition-colors">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 16v1a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3v-1"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Deploy
        </button>
      </form>
      <form method="post" action="/repos/{{ repo.id }}/restart">
        <button type="submit"
                class="inline-flex items-center gap-1.5 rounded-lg px-3 py-1.5 text-xs font-medium text-[#e3b341] border border-[#e3b34144] bg-[#0d1117] hover:bg-[#201d0d] transition-colors">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.5"/></svg>
          Restart
        </button>
      </form>
      <form method="post" action="/repos/{{ repo.id }}/stop"
            onsubmit="return confirm('Stop and remove {{ repo.container_name }}?')">
        <button type="submit"
                class="inline-flex items-center gap-1.5 rounded-lg px-3 py-1.5 text-xs font-medium text-[#f85149] border border-[#f8514944] bg-[#0d1117] hover:bg-[#2a1010] transition-colors">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
          Kill
        </button>
      </form>
      <form method="post" action="/repos/{{ repo.id }}/delete"
            onsubmit="return confirm('Delete {{ repo.container_name }}?')">
        <button type="submit"
                class="btn-danger inline-flex items-center gap-1.5 rounded-lg px-3 py-1.5 text-xs">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
          Delete
        </button>
      </form>
    </div>

  </div>
  {% endfor %}
</div>

{% endif %}

<!-- Webhook info footer -->
<div class="mt-8 card rounded-xl p-4 flex items-center gap-3 text-xs text-muted">
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="{{ ui.accent_color }}" stroke-width="2" class="shrink-0"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg>
  <span>Configure GitHub webhooks to POST to <code class="text-[#e6edf3] bg-[#0d1117] px-1.5 py-0.5 rounded">{{ webhook_url }}</code> â€” event type: <code class="text-[#e6edf3] bg-[#0d1117] px-1.5 py-0.5 rounded">workflow_run</code></span>
</div>

{% endblock %}
