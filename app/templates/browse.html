{% extends "base.html" %}
{% block title %}Browse Repos ‚Äî {{ ui.app_title }}{% endblock %}

{% block content %}
<div class="flex items-center gap-3 mb-7">
  <a href="/repos/new" class="text-muted hover:text-[#e6edf3] transition-colors">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
  </a>
  <div class="flex-1">
    <h1 class="text-lg font-semibold text-[#e6edf3]">Browse GitHub Repositories</h1>
    <p class="text-xs text-muted mt-0.5">Showing repos you have access to with a GHCR container package</p>
  </div>
  {% if gh_connected %}
  <div class="flex items-center gap-3">
    <span class="flex items-center gap-1.5 text-xs text-accent">
      <span class="w-1.5 h-1.5 rounded-full bg-accent inline-block"></span>
      {% if gh_username %}@{{ gh_username }}{% else %}GitHub connected{% endif %}
    </span>
    <a href="/auth/github/disconnect"
       class="btn-ghost rounded-lg px-3 py-1.5 text-xs">Disconnect</a>
  </div>
  {% elif gh_oauth_ok %}
  <a href="/auth/github?next=/repos/browse"
     class="btn-primary rounded-lg px-4 py-2 text-xs flex items-center gap-2">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0 0 24 12c0-6.63-5.37-12-12-12z"/></svg>
    Connect GitHub
  </a>
  {% else %}
  <div class="text-xs text-muted bg-[#1a0d0d] border border-[#f8514922] rounded-lg px-3 py-2">
    Set <code class="text-[#e6edf3]">GITHUB_CLIENT_ID</code> + <code class="text-[#e6edf3]">GITHUB_CLIENT_SECRET</code> to enable OAuth
  </div>
  {% endif %}
</div>

<!-- Search bar -->
<div class="relative mb-5">
  <svg class="absolute left-3 top-1/2 -translate-y-1/2 text-muted" width="14" height="14"
       viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
  </svg>
  <input id="search-input" type="text"
         placeholder="Search repositories‚Ä¶"
         class="input-field w-full rounded-lg pl-9 pr-4 py-2.5 text-sm"
         oninput="onSearch(this.value)" />
</div>

<!-- Status / loading -->
<div id="status" class="text-xs text-muted mb-4 hidden"></div>

<!-- Repo grid -->
<div id="repo-grid" class="grid grid-cols-1 gap-3"></div>

<!-- Load more -->
<div class="text-center mt-6 hidden" id="load-more-wrap">
  <button onclick="loadMore()" id="load-more-btn"
          class="btn-ghost rounded-lg px-6 py-2 text-xs">
    Load more
  </button>
</div>

<!-- Empty state -->
<div id="empty-state" class="hidden card rounded-xl p-12 text-center">
  <div class="text-3xl mb-3">üîç</div>
  <p class="text-sm text-[#e6edf3] font-medium mb-1">No repositories found</p>
  <p class="text-xs text-muted">No repos with GHCR packages found. Try searching, or check that your GitHub token has <code class="text-[#e6edf3]">read:packages</code> access.</p>
</div>

<script>
  let currentPage = 1;
  let currentQ    = '';
  let debounceTimer;
  const tracked = {{ repos_set | tojson | default("[]") }};

  const grid      = document.getElementById('repo-grid');
  const status    = document.getElementById('status');
  const emptyEl   = document.getElementById('empty-state');
  const moreWrap  = document.getElementById('load-more-wrap');

  function setStatus(msg) {
    status.textContent = msg;
    status.classList.toggle('hidden', !msg);
  }

  function renderRepo(repo) {
    const isAdded = tracked.includes(repo.full_name);
    const langColours = {
      Python: '#3572A5', JavaScript: '#f1e05a', TypeScript: '#2b7489',
      Go: '#00ADD8', Rust: '#dea584', Java: '#b07219', default: '#8b949e'
    };
    const langColor = langColours[repo.language] || langColours.default;

    const card = document.createElement('div');
    card.className = 'card rounded-xl p-4 flex items-center gap-4 hover:border-[#8b949e] transition-colors';
    card.innerHTML = `
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-2 flex-wrap mb-1">
          <span class="text-sm font-semibold text-[#e6edf3]">${repo.full_name}</span>
          ${repo.private
            ? '<span class="tag tag-warn">private</span>'
            : '<span class="tag tag-info">public</span>'}
          ${isAdded ? '<span class="tag">‚úì added</span>' : ''}
        </div>
        ${repo.description
          ? `<p class="text-xs text-muted truncate mb-2">${repo.description}</p>`
          : ''}
        <div class="flex items-center gap-3 text-[10px] text-muted overflow-hidden">
          ${repo.language ? `
            <span class="flex items-center gap-1 shrink-0">
              <span style="width:8px;height:8px;border-radius:50%;background:${langColor};display:inline-block"></span>
              ${repo.language}
            </span>` : ''}
          ${repo.updated_at
            ? `<span class="shrink-0">Updated ${repo.updated_at}</span>`
            : ''}
          <code class="text-[#484f58] truncate">${repo.image}</code>
        </div>
      </div>
      <a href="/repos/new?repo=${encodeURIComponent(repo.full_name)}"
         class="${isAdded ? 'btn-ghost' : 'btn-primary'} shrink-0 rounded-lg px-3 py-1.5 text-xs">
        ${isAdded ? 'Edit' : 'Add'}
      </a>
    `;
    return card;
  }

  async function loadRepos(page, q, append) {
    setStatus('Loading‚Ä¶');
    try {
      const params = new URLSearchParams({ page, q });
      const res    = await fetch(`/api/github/repos?${params}`);
      const data   = await res.json();

      if (!res.ok) {
        const msg = data.error || `GitHub API error ${res.status}`;
        if (res.status === 401) {
          grid.innerHTML = `<div class="card rounded-xl p-10 text-center col-span-full">
            <p class="text-sm text-[#e6edf3] font-medium mb-2">GitHub not connected</p>
            <p class="text-xs text-muted mb-4">You need to connect your GitHub account to browse repositories.</p>
            <a href="/auth/github?next=/repos/browse" class="btn-primary rounded-lg px-5 py-2 text-xs inline-block">Connect GitHub</a>
          </div>`;
        } else {
          setStatus(msg);
        }
        return;
      }

      if (!append) grid.innerHTML = '';
      setStatus('');

      if (data.length === 0 && !append) {
        emptyEl.classList.remove('hidden');
        moreWrap.classList.add('hidden');
        return;
      }

      emptyEl.classList.add('hidden');
      data.forEach(r => grid.appendChild(renderRepo(r)));
      moreWrap.classList.toggle('hidden', data.length < 30);
    } catch(e) {
      setStatus('Network error ‚Äî check console');
      console.error(e);
    }
  }

  function onSearch(val) {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      currentQ    = val.trim();
      currentPage = 1;
      loadRepos(1, currentQ, false);
    }, 350);
  }

  function loadMore() {
    currentPage++;
    loadRepos(currentPage, currentQ, true);
  }

  // On the add form, if ?repo= is passed, trigger autofill
  const urlRepo = new URLSearchParams(location.search).get('repo');
  if (urlRepo) {
    // Redirect straight to the new form with the repo pre-filled via lookup
    location.href = `/repos/new?repo=${encodeURIComponent(urlRepo)}`;
  } else {
    loadRepos(1, '', false);
  }
</script>

{% endblock %}
